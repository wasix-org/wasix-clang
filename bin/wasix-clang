#!/usr/bin/env bash
set -euo pipefail
shopt -s extglob

WASIX_CLANG_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
WASIX_CLANG_REPO_ROOT=$(dirname $WASIX_CLANG_DIR)
DEFAULT_SYSROOT=$WASIX_CLANG_REPO_ROOT/wasix-sysroot
DEFAULT_LLVM=$WASIX_CLANG_REPO_ROOT/wasix-llvm
DEFAULT_BINARYEN=$WASIX_CLANG_REPO_ROOT/binaryen
if ! test -d "${DEFAULT_SYSROOT}" || ! test -d "${DEFAULT_LLVM}" || ! test -d "${DEFAULT_BINARYEN}" ; then
    echo "You are running wasix-clang for the first time. This will take a moment, as we need to fetch dependencies." >&2
    bash ${WASIX_CLANG_REPO_ROOT}/setup.sh
    echo "Done fetching dependencies. Please try again to actually use them." >&2
    exit 1
fi

### Options
# Force libraries to be resolved to `.a` files instead of `.so` files.
WASIX_FORCE_STATIC_DEPENDENCIES="${WASIX_FORCE_STATIC_DEPENDENCIES:=false}"
# Do not link libc++, libc++abi, and libunwind. This is only relevant when building libc++ itself.
WASIX_DONT_LINK_LIBCXX="${WASIX_DONT_LINK_LIBCXX:=false}"
# Set the wasix sysroot to use.
WASIX_SYSROOT="${WASIX_SYSROOT:=$DEFAULT_SYSROOT}"
# Set the root of the llvm/clang tools to use.
WASIX_LLVM="${WASIX_LLVM:=$DEFAULT_LLVM}"
# Set the root of the binaryen tools to use.
WASIX_BINARYEN="${WASIX_BINARYEN:=$DEFAULT_BINARYEN}"

if ! test -d "${WASIX_SYSROOT}" ; then
    echo "WASIX_SYSROOT ($WASIX_SYSROOT) does not point to a valid sysroot. Please make sure it exists." >&2
    exit 1
fi
if ! test -d "${WASIX_LLVM}" ; then
    echo "WASIX_LLVM ($WASIX_LLVM) does not point to a valid llvm install. Please make sure it exists." >&2
    exit 1
fi
if ! test -d "${WASIX_BINARYEN}" ; then
    echo "WASIX_BINARYEN ($WASIX_BINARYEN) does not point to a valid binaryen install. Please make sure it exists." >&2
    exit 1
fi

# Detect if we are clang or clang++
if [[ "$0" =~ "++" ]]; then
    NATIVE_COMPILER="${WASIX_LLVM}/bin/clang++"
else
    NATIVE_COMPILER="${WASIX_LLVM}/bin/clang"
fi
# Prefer vendored LLVM and binaryen path over system path
export PATH="${WASIX_LLVM}/bin:${WASIX_BINARYEN}/bin:$PATH"

PASSED_ARGS=(
    "$@"
)

# Analyze the arguments
# Check if we are also linking
run_linker=true
# We are building a shared library
shared_library=false
for arg in "${PASSED_ARGS[@]}"; do
    case "$arg" in
        -c|-S|-E)
            run_linker=false
            ;;
        --version|-print*)
            run_linker=false
            ;;
        -shared|--shared)
            shared_library=true
            ;;
    esac
done

COMPILER_ARGS=(
    --target=wasm32-wasi
    --sysroot="${WASIX_SYSROOT}"
    
    -iwithsysroot "/usr/local/include/c++/v1"
    -iwithsysroot "/include/c++/v1"
    -iwithsysroot "/usr/include/c++/v1"
    -isystem "${WASIX_LLVM}/lib/clang/21/include"
    -iwithsysroot "/usr/local/include"
    -iwithsysroot "/include"
    -iwithsysroot "/usr/include"

    -matomics -mbulk-memory -mmutable-globals
    -pthread
    -mthread-model posix
    -ftls-model=global-dynamic
    -fno-trapping-math
    -D_WASI_EMULATED_MMAN -D_WASI_EMULATED_SIGNAL -D_WASI_EMULATED_PROCESS_CLOCKS
    -fvisibility=default
    -fwasm-exceptions
    -fPIC
    # Disable some new warnings
    # TODO: Test if these can be reenabled
    -Wno-int-conversion -Wno-implicit-function-declaration -Wno-default-const-init-var-unsafe -Wno-error=deprecated-literal-operator -Wno-error=sign-conversion -Wno-error=character-conversion
    # TODO: These should actually be enabled again, but for now they are disabled
    # This allows us to compile some ancient shitty code without failing. We should move these flags to the appropriate place in build-scripts
    -Wno-error=implicit-fallthrough -Wno-error=nontrivial-memcall -Wno-error=zero-as-null-pointer-constant -Wno-error=unsafe-buffer-usage -Wno-error=exceptions -Wno-error=padded -Wno-error=disabled-macro-expansion -Wno-error=suggest-override -Wno-error=suggest-destructor-override -Wno-error=extra-semi-stmt -Wno-error=deprecated-copy-with-user-provided-copy  -Wno-error=format -Wno-error=shadow -Wno-error=c++98-compat-pedantic -Wno-error=unused-command-line-argument
    # Enable sjlj. This is unused when we are only linking, but figuring out if we are only linking is hard
    --start-no-unused-arguments -mllvm --wasm-enable-sjlj -mllvm --wasm-use-legacy-eh=false --end-no-unused-arguments
    # We are getting some weird overflows without this flag. 
    # pointer + ((unsigned long)-1) = 0xFFFFFFFFFFFFFFFF
    -fno-strict-overflow

    # For more deterministic builds
    # -Wno-builtin-macro-redefined -D__DATE__= -D__TIME__= -D__TIMESTAMP__= 
    -no-canonical-prefixes
)
COMMON_LINKER_ARGS=(

    # Added with -Wl, so they appear after the explicit linker flags
    -Wl,-L${WASIX_SYSROOT}/lib
    -Wl,-L${WASIX_SYSROOT}/lib/wasm32-wasi
    -Wl,-L${WASIX_SYSROOT}/usr/lib
    -Wl,-L${WASIX_SYSROOT}/usr/lib/wasm32-wasi
    -Wl,-L${WASIX_SYSROOT}/usr/local/lib
    -Wl,-L${WASIX_SYSROOT}/usr/local/lib/wasm32-wasi

    # Enable PIC
    -Wl,--experimental-pic
    -Wl,--extra-features=atomics,--extra-features=bulk-memory,--extra-features=mutable-globals
    -Wl,--shared-memory
    -Wl,--export-if-defined=__wasm_apply_data_relocs
    -Wl,--export-if-defined=__cxa_thread_atexit_impl
    -Wl,--export=__wasm_call_ctors
    -Wl,-mllvm,--wasm-enable-sjlj
    -Wl,-mllvm,--wasm-use-legacy-eh=false
)
LIBRARY_LINKER_ARGS=(
    # No standard libraries, because the main executable already provides them
    --no-standard-libraries -nostdlib++ -Wl,--no-entry
    # Build a shared library
    --shared
    # Import all unresolved symbols
    -Wl,--unresolved-symbols=import-dynamic
    -Wl,-lclang_rt.builtins-wasm32
    ${WASIX_SYSROOT}/lib/wasm32-wasi/scrt1.o
)

LINK_LIBCXX_ARGS=,-lc++,-lc++abi,-lunwind
if [[ "$WASIX_DONT_LINK_LIBCXX" == "true" ]]; then
    # Only relevant when building libc++ itself
    # TODO: Remove this once we have a shared libc++ build
    LINK_LIBCXX_ARGS=
fi

EXECUTABLE_LINKER_ARGS=(
    -Wl,--import-memory
    -Wl,-pie
    -Wl,--export-all
    # Allow multiple definitions. This emulates the behaviour when linking a shared library where it is allowed to override libc functions
    # If there is a way to only allow multiple definitions for libc functions, please let me know
    -Wl,--allow-multiple-definition
    -Wl,--whole-archive,-lc,-lutil,-lresolv,-lrt,-lm,-lpthread${LINK_LIBCXX_ARGS},-lwasi-emulated-mman,-lwasi-emulated-getpid,-lcommon-tag-stubs,--no-whole-archive
)

UNSUPPORTED_LINKER_ARGS=(
    --end-group
    --start-group
    --as-needed
    --no-as-needed
    --allow-shlib-undefined
    --enable-new-dtags
    # Version script is not supported by wasm-ld
    "--version-script=*([^,])"
    "--version-script,*([^,])"
    # Stats not supported by wasm-ld
    "*-stats"
)

UNSUPPORTED_CC_ARGS=(
    # Remove explicit scrt1.o, because wasix-clang already added it
    "${WASIX_SYSROOT}/lib/wasm32-wasi/scrt1.o"
    # Version script is not supported by wasm-ld
    # TODO: Also strip `--version-script script` if there is a need for it
    "--version-script=*([^,])"
    "-march=native"
)

if [[ "${PASSED_ARGS[@]}" == *"-o conftest"* ]] ; then
    # Heuristically detect if we are running an autoconf test. Then disable the shlib signature check so it works. This is a hack, but it works for now.
    #
    # autoconfs AC_CHECK_LIB tests for functions in libraries but always uses a () => i32 signature.
    # See: https://www.gnu.org/software/autoconf/manual/autoconf-2.66/html_node/Libraries.html
    COMMON_LINKER_ARGS+=( -Wl,--no-shlib-sigcheck )
fi

FILTERED_PASSED_ARGS=( )
for arg in "${PASSED_ARGS[@]}"; do
    # Remove unsupported arguments
    for unsupported_cc_arg in "${UNSUPPORTED_CC_ARGS[@]}"; do
        if [[ "$arg" == $unsupported_cc_arg ]]; then
            continue 2
        fi
    done

    # Filter unsupported linker arguments
    if [[ "$arg" = "-Wl,"* ]]; then
        for unsupported_linker_arg in "${UNSUPPORTED_LINKER_ARGS[@]}"; do
            arg="${arg//,$unsupported_linker_arg/}"
        done
        [[ "$arg" == "-Wl" ]] && continue || true
    fi

    # Force dependencies to be resolved to static libraries if requested
    if "$WASIX_FORCE_STATIC_DEPENDENCIES" && [[ "$arg" == "-l"[^/:]* ]]; then
        basename="${arg/#-l/}"
        arg="-l:lib${basename}.a"
    fi

    # Add all other arguments to our filtered list
    FILTERED_PASSED_ARGS+=("$arg")
done

ARGS=()
ARGS+=("${COMPILER_ARGS[@]}")
if $run_linker; then
    ARGS+=("${COMMON_LINKER_ARGS[@]}")

    if $shared_library; then
        ARGS+=("${LIBRARY_LINKER_ARGS[@]}")
    else
        ARGS+=("${EXECUTABLE_LINKER_ARGS[@]}")
    fi
fi


ARGS+=("${FILTERED_PASSED_ARGS[@]}")


exec ${NATIVE_COMPILER} "${ARGS[@]}"